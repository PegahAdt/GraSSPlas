# GraSSPlas pseudolabels

This branch contains the instructions to generate the pseudolabels required for GraSSPlas.

## Installation & Dependencies

The code was run on Python 3.11. We also require the pandas and Bio libraries for this code.
We also require Basic Local Alignment Search Tool (BLAST) for mapping the genes or proteins onto the short read contigs.


## Running the Codes

1. **Running BLAST**

BLAST can be installed locally on a Linux based OS using the following command:
```
sudo apt install ncbi-blast+
``` 
Note that BLAST is already installed on cedar. 

We wish to map the genes onto short read contigs. In this scenario, the short read FASTA file for the sample acts as the database for BLAST.
```
makeblastdb -in SR_FASTA_FILE -dbtype nucl -out BLAST_DB
```
This command creates a database using `SR_FASTA_FILE` of short read contigs, which are nucleotide (`nucl`) sequences and saves it to `BLAST_DB`.

We have two types of sequences we wish to map onto the contigs: gene sequences and protein sequences. These sequences can be obtained by manually downloading them as instructed on https://github.com/phac-nml/mob-suite. This will download a zipped folder `data.tar.gz`, under which the required sequences are stored.

The gene sequences include the replicon sequences and the origin of transfer. These have been stored in FASTA files `rep.dna.fas` and `orit.fas` under the zipped folder. To run BLAST on these files:
```
blastn -query GENES_FASTA -db BLAST_DB -out BLAST_OUT -outfmt 6
```
Here `GENES_FASTA` are the DNA FASTA files mentioned above. `BLAST_DB` is the BLAST database of contigs generated above. `BLAST_OUT` is the output file.

The protein sequences include the mate-pair formation proteins and mobility proteins. These have been stored in FASTA files `mpf.proteins.faa` and `mob.proteins.faa` under the zipped folder. To run BLAST on this files:
```
tblastn -query PROTEINS_FASTA -db BLAST_DB -out BLAST_OUT -outfmt 6
```
Here `PROTEINS_FASTA` are the protein FASTA files mentioned above. 

2. **Reading BLAST**

To read the BLAST output in output format 6:
```
python read_blast_output.py --sequences SEQUENCES_FASTA --assembly ASSEMBLY_FASTA \ 
                            --mapping BLAST_OUT --threshold PID_THR \ 
									          --outdir PLSNESS_FOLDER --outfile OUT_FILENAME	
```
Here, the `SEQUENCES_FASTA` is the file containing the gene or protein sequences. The `ASSEMBLY_FASTA` is the short read contigs FASTA file. The `BLAST_OUT` is the TSV file generated by BLAST. `PID_THR` is the identity threshold (float, between 0 and 1) required to ensure the quality of mapping. *Note: Additionally, one more threshold should be included here. The `COV_THR` to ensures what percentage of the gene / protein is covered by the contig. Currently, I have hard-coded it to be 0.8.*

The output (stored in `PLSNESS_FOLDER/OUT_FILENAME`) for the processed BLAST results is in TSV format, as follows:
```
CTG_ID  SEQ_ID  COVERAGE  CTG_LEN SEQ_LEN
```
For convenience, the `OUT_FILENAME` is assumed to be the `SEQUENCE_TYPE` followed by `_mapping.tsv`.  Here, the `SEQUENCE_TYPE` is one of [`replicon`, `origintransfer`, `mobility`, `matepair`].

3. **Generating pseudolabels**

To generate plasmid labels, we use the processed BLAST results stored in the `PLSNESS_FOLDER` folder above. Any contig that appears in at least one of the mapping files is assigned the label plasmid. For chromosome labels, we need access to the assembly GFA files for each sample. For each sample, the mean (m) and standard deviation (sd) of the coverage of all contigs is computed. A contig is labelled chromosome if it has some minimum length and has coverage at most m+2sd.

```
python generate_pseudolabels.py --assembly GFA_FILE --plsness PLSNESS_FOLDER --len_threshold LEN_THR --outdir LABELS_DIR
```
Here, `GFA_FILE` is the sample assembly GFA file. `PLSNESS_FOLDER` is the folder containing the four processed BLAST mapping files. `LEN_THR` is the length threshold for chromosomes. 

`LABELS_DIR` is the directory under which the labels will be stored in a TSV file `pseudolabels.tsv`. The output file has the following format:
```
contig  chromosome  plasmid
```
  







